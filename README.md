magnit: документация разработчика

\

В инфраструктуре используется 4 среды:

-   **test**: разработка -
    [https://apteka-test.magnit.ru](https://apteka-test.magnit.ru/)

-   **stage**: тесты релизов -
    [https://apteka-stage.magnit.ru](https://apteka-stage.magnit.ru/)

-   **stage2**: тесты хотфиксов -
    [https://apteka-stage2.magnit.ru](https://apteka-stage2.magnit.ru/)

-   **prod**: продуктивный ландшафт
    [https://apteka.magnit.ru](https://apteka.magnit.ru/)

Также имеется общая для всех **staff** среда, куда вынесены служебные
серверы:

-   grafana - мониторинг на базе Grafana/Prometheus
    [http](https://mon.m.mcs.im/)[s](https://mon.m.mcs.im/)[://mon.m.mcs.im/](https://mon.m.mcs.im/)

-   gitlab - общая ci/cd система и хранилище GIT
    [http](https://git.m.mcs.im/)[s](https://git.m.mcs.im/)[://git.m.mcs.im/](https://git.m.mcs.im/)

    -   группа
        [https://git.m.mcs.im/apteka](https://git.m.mcs.im/apteka) - все
        репозитории ИМ Аптеки

    -   группа
        [https://git.m.mcs.im/delivery](https://git.m.mcs.im/delivery) -
        все репозитории Доставки

-   sentry - локальная инсталляция sentry.io
    [http://sentry.magnit.ru](http://sentry.magnit.ru/)

-   vpn - OpenVPN сервер для доступа к внутренним ресурсам и DNS

-   proxy - прокси privoxy для выхода серверов в интернет (пакеты)

-   loader - сервер генерации трафика для нагрузочного тестирования

-   logs - файловый сервер сбора объемных mdm логов bitrix (ssh, grep,
    awk)

\

**IP адреса служебных серверов:**

  ----------------------- ------------------------------
  magnit-staff-vpn        10.9.49.37 и 185.241.192.189
  magnit-staff-grafana    10.9.49.40
  magnit-staff-proxy      10.9.49.44
  magnit-staff-git        10.9.49.45
  magnit-staff-loader01   10.9.49.42
  magnit-staff-logs       10.9.49.50
  magnit-staff-sentry     10.9.49.43
  ----------------------- ------------------------------

\

**Доступы** в OpenVPN, Grafana, Gitlab, SSH, RabbitMQ, Kibana, Sentry и
другие - **получить через своего непосредственного руководителя
проекта**. При запросе предоставлять правильные написания имени и
фамилии латинскими буквами и рабочий e-mail, например: Ivan Petrov
i.petroff@company.ru Основные внутренние ресурсы будут доступны после
подключения к VPN и настройки внутреннего DNS сервера. При подключении к
VPN сервер DNS выдающий внутренние имена - назначается по DHCP. Доступ
на серверы по SSH осуществляется по внутренним IP адресам.

**Резервное копирование** осуществляется через s3, sqldump и средствами
платформы Acronis по регламенту из ТЗ. На логическом уровне
осуществляется резервное копирование статики и влитие её в отдельные s3
бакеты из среды prod в среды stage, stage2 и test. Базы данных
восстанавливаются со среды prod на среды stage, stage2 и test также
через s3. Полное физическое копирование виртуальных машин, на которые
можно восстановить логические данные - выполняется средствами Acronis
только для среды prod.

\

**Общая схема серверов:**

![](magnit%20%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D1%8F%20%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%87%D0%B8%D0%BA%D0%B0_html_1881eaa38ecf9e89.png)

\

Исчерпывающее описание параметров работы данных серверов содержится в
изначальном техническом задании. Регламенты взаимодействия команд
разработки и поддержки описываются в отдельных регламентах и доступны к
ознакомлению у менеджеров проекта.

**Схема работы сервиса “Доставка” (GoLang, Postgres, Krakend)**

\

![](magnit%20%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D1%8F%20%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%87%D0%B8%D0%BA%D0%B0_html_f994d599f4898bae.jpg)

\

\

\

\

\

\

\

\

\

\

\

\

\

\

\

**Таблица входящих/исходящих IP адресов**

  ------------------------------- --------------- ----------------- ----------------- ----------------
  \                               apteka-test     apteka-stage      apteka-stage2     apteka
                                                                                      
                                  dostavka-test   dostavka-stage    dostavka-stage2   dostavka
                                                                                      
                                  express-test    express-stage     express-stage2    express
                                                                                      
                                  cosmetic-test   cosmetic-stage    cosmetic-stage2   cosmetic

  Внутренние IP front (nuxt/js)   10.9.52.200     10.9.49.218       10.9.52.140       10.9.49.146
                                                                                      
                                  10.9.52.201     10.9.49.224       10.9.52.141       10.9.49.132

  Плавающие IP admin              нет             10.9.49.235       нет               10.9.49.142
                                                                                      
                                                  10.9.49.236                         10.9.49.133

  Внешние IP                      89.208.230.99   89.208.221.238    213.219.212.253   89.208.230.112
                                                                                      
  front (nuxt/js)                 185.86.145.22   213.219.215.179   213.219.214.67    95.163.212.190

  Почтовый релей mail01           185.86.147.4    185.241.194.144   185.86.144.253    185.241.193.77

  Исходящий IP                    185.86.145.7    213.219.213.112   185.86.146.73     95.163.214.66
                                                                                      
  (router,ipsec)                                                                      

  Анти-DDOS                       нет             нет               нет               185.169.153.25
  ------------------------------- --------------- ----------------- ----------------- ----------------

\

Таблица адресов управления SSH серверов

  -------------- ------------- ------------- ------------- -------------
  \              **test**      **stage**     **stage2**    **prod**
                                                           

  front01        10.9.52.200   10.9.49.218   10.9.52.140   10.9.49.132

  front02        10.9.52.201   10.9.49.224   10.9.52.141   10.9.49.146

  app01          10.9.52.202   10.9.49.204   10.9.52.142   10.9.49.134

  app02          10.9.52.203   10.9.49.207   10.9.52.143   10.9.49.136

  app03          нет           10.9.49.203   нет           10.9.49.143

  app04          нет           нет           нет           10.9.49.149

  admin01        10.9.52.204   10.9.49.198   10.9.52.144   10.9.49.161

  admin02        10.9.52.205   10.9.49.234   10.9.52.145   10.9.49.162

  cache01        10.9.52.206   10.9.49.200   10.9.52.146   10.9.49.144

  cache02        10.9.52.207   10.9.49.197   10.9.52.147   10.9.49.156

  cache03        10.9.52.208   10.9.49.201   10.9.52.148   10.9.49.138

  catalog01      10.9.52.226   10.9.49.217   10.9.52.149   10.9.49.151

  catalog02      10.9.52.210   10.9.49.219   10.9.52.150   10.9.49.152

  catalog03      10.9.52.211   10.9.49.220   10.9.52.151   10.9.49.147

  log01          10.9.52.224   10.9.49.208   10.9.52.164   10.9.49.155

  log02          нет           10.9.49.199   нет           10.9.49.153

  log03          нет           10.9.49.202   нет           10.9.49.154

  db01           10.9.52.212   10.9.49.212   10.9.52.152   10.9.49.148

  db02           10.9.52.213   10.9.49.196   10.9.52.153   10.9.49.150

  db03           нет           10.9.49.205   нет           10.9.49.157

  db04           нет           нет           нет           10.9.49.158

  monitoring01   10.9.52.223   10.9.49.209   10.9.52.163   10.9.49.141

  monitoring02   нет           10.9.49.223   нет           10.9.49.135

  mail01         10.9.52.225   10.9.49.222   10.9.52.165   10.9.49.159

  dapp01         10.9.52.214   10.9.49.225   10.9.52.154   10.9.49.163

  dapp02         10.9.52.215   10.9.49.226   10.9.52.155   10.9.49.164

  dapp03         нет           нет           нет           10.9.49.165

  dadmin01       10.9.52.216   10.9.49.227   10.9.52.156   10.9.49.166

  dadmin02       10.9.52.217   10.9.49.228   10.9.52.157   10.9.49.167

  ddb01          10.9.52.218   10.9.49.229   10.9.52.158   10.9.49.168

  ddb02          10.9.52.219   10.9.49.230   10.9.52.159   10.9.49.169

  ddb03          нет           нет           нет           10.9.49.170

  dconsul01      10.9.52.220   10.9.49.231   10.9.52.160   10.9.49.171

  dconsul02      10.9.52.221   10.9.49.232   10.9.52.161   10.9.49.172

  dconsul03      10.9.52.222   10.9.49.233   10.9.52.162   10.9.49.173
  -------------- ------------- ------------- ------------- -------------

\

\

Административные интерфейсы /bitrix/admin закрыты basic авторизацией.
Доступы basic авторизации можно сохранить в браузере для удобства. Также
basic авторизацией может быть закрыт весь ландшафт (кроме
продуктивного). После ввода имени пользователя и пароля для basic
авторизации становится доступен интерфейс Bitrix. Доступы в интерфейс
BITRIX необходимо получить отдельно.

\

Таблица доступов basic авторизации

  ---------------------------------------------------------------------------------------------- -------------- ------------------
  Интерфейс                                                                                      Пользователь   Пароль
  [https://apteka-test.magnit.ru/bitrix/admin](https://apteka-test.magnit.ru/bitrix/admin)       authorized     de2niebaiyeiMoo6
  [https://apteka-stage.magnit.ru/bitrix/admin](https://apteka-stage.magnit.ru/bitrix/admin)     authorized     OSh8eesoxahz1aeV
  [https://apteka-stage2.magnit.ru/bitrix/admin](https://apteka-stage2.magnit.ru/bitrix/admin)   authorized     aingech3aeShohch
  [https://apteka.magnit.ru/bitrix/admin](https://apteka.magnit.ru/bitrix/admin)                 authorized     по запросу
  ---------------------------------------------------------------------------------------------- -------------- ------------------

\

\

\

\

\

\

\

\

Таблица описания функционала серверов

  --------------------- -------------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  **Группа серверов**   **Стек ПО**    **Функционал и резервирование**

  frontend              nginx          На сервере развернута сборка frontend nuxt, используется server-side rendering (SSR). При помощи pm2 запросы распределяются на процессы nuxt, их количество равно количеству CPU
                                       
                        nuxt.js        
                                       
                        pm2            

  app                   nginx          На сервере развернут BITRIX, обеспечивается API для frontend серверов. Запросы приходят в php-fpm через nginx. RabbitMQ собран в кластере на всех app и admin серверах. HAProxy переключает запросы в memcached и elastic. Обрабатывается локация /api
                                       
                        php-fpm        
                                       
                        haproxy        
                                       
                        rabbitmq       

  admin                 nginx          Тот же функционал что и у app серверов, добавлена локация /bitrix/admin в nginx для администрирования. Keepalived сохраняет 2 плавающих IP постоянно доступным для всех интеграций при выводе одного любого сервера. Попасть на конкретный admin сервер можно как с помощью IP адреса.
                                       
                        php-fpm        \
                                       
                        keepalived     [http://10.9.49.161/bitrix/admin/\#authorize](http://10.9.49.161/bitrix/admin/#authorize)
                                       
                        haproxy        
                                       
                        rabbitmq       

  cache                 tarantool      Memcached кластер для хранения сессий, реализованный на базе Tarantool в режиме 1+1+1

  catalog               elastic        Кластер ELK с проиндексированными товарами в режиме 1+1+1
                                       
                        logstash       
                                       
                        kibana         

  log                   elastic        Кластер ELK с логами от всех приложений в режиме 1+1+1
                                       
                        logstash       
                                       
                        kibana         

  mysql                 mysql          Сервера баз данных MySQL для BITRIX в режиме master-slave репликации, где db01 - master, db02 - slave, db03 - slave для MDM (только stage и prod), db04 - отстающая на 2 часа реплика (только на prod)
                                       
                        percona        

  monitoring            prometheus     База данных Prometheus и менеджер аварийных уведомлений Alertmanager. Для prod и stage среды реализованы в отказоустойчивой конфигурации 1+1. Система визуализации Grafana находится на staff среде и общая для всех сред, включая staff.
                                       
                        alertmanager   

  mail                  postfix        Почтовый релей для отправки писем о регистрации пользователей, восстановления паролей и других задач

  dapp                  nginx          Стек приложений сервисов Доставки на GoLang. Шина данных NATS, и шлюз для API Krakend.
                                       
                        golang         
                                       
                        krakend        
                                       
                        nats           

  dadmin                nginx          Административный интерфейс сервиса Доставки

  ddb                   postgresql     Базы данных сервисов доставки PostgreSQL в кластере Patroni с балансировкой чтения/записи
                                       
                        patroni        
                                       
                        haproxy        

  dconsul               consul         Кластер Consul для хранения состояния и статусов master/slave серверов группы ddb Patroni
  --------------------- -------------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

\

Таблица доступов к **ELK** с кешем товаров

  -------------------------------------------------------------------------------------------------- ----------------- -----------------
  Интерфейс                                                                                          Пользователь      Пароль
  [https://apteka-test.magnit.ru/kibana-catalog](https://apteka-test.magnit.ru/kibana-catalog)       без авторизации   без авторизации
  [https://apteka-stage.magnit.ru/kibana-catalog](https://apteka-stage.magnit.ru/kibana-catalog)     без авторизации   без авторизации
  [https://apteka-stage2.magnit.ru/kibana-catalog](https://apteka-stage2.magnit.ru/kibana-catalog)   без авторизации   без авторизации
  [https://apteka-prod.magnit.ru/kibana-catalog](https://apteka-prod.magnit.ru/kibana-catalog)       без авторизации   без авторизации
  -------------------------------------------------------------------------------------------------- ----------------- -----------------

\

Таблица доступов к **ELK** с логами

  -------------------------------------------------------------------------------------------- ----------------- -----------------
  Интерфейс                                                                                    Пользователь      Пароль
  [https://apteka-test.magnit.ru/kibana-logs](https://apteka-test.magnit.ru/kibana-logs)       без авторизации   без авторизации
  [https://apteka-stage.magnit.ru/kibana-logs](https://apteka-stage.magnit.ru/kibana-logs)     без авторизации   без авторизации
  [https://apteka-stage2.magnit.ru/kibana-logs](https://apteka-stage2.magnit.ru/kibana-logs)   без авторизации   без авторизации
  [https://apteka-prod.magnit.ru/kibana-logs](https://apteka-prod.magnit.ru/kibana-logs)       без авторизации   без авторизации
  -------------------------------------------------------------------------------------------- ----------------- -----------------

\

Таблица доступов к **RabbitMQ** admin

  -------------------------------------------------------------------------------------------------- -------------- ------------------
  Интерфейс                                                                                          Пользователь   Пароль
  [https://apteka-test.magnit.ru/rmq-management](https://apteka-test.magnit.ru/rmq-management)       queue\_admin   deiDei5eekiel8ow
  [https://apteka-stage.magnit.ru/rmq-management](https://apteka-stage.magnit.ru/rmq-management)     queue\_admin   ii9ruNoahogooqu1
  [https://apteka-stage2.magnit.ru/rmq-management](https://apteka-stage2.magnit.ru/rmq-management)   queue\_admin   emeeShohheengig3
  [https://apteka-prod.magnit.ru/rmq-management](https://apteka-prod.magnit.ru/rmq-management)       queue\_admin   по запросу
  -------------------------------------------------------------------------------------------------- -------------- ------------------

\

В случае если браузер выдает на эти интерфейсы 404 - значит либо нет
подключения к VPN, либо браузер запущен до подключения к VPN и
закешировал в DNS внешние IP адреса данных URL. Необходимо перезапустить
браузер.

\

\

